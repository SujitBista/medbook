name: Prevent Direct Push to Main

on:
  push:
    branches:
      - main

jobs:
  block-direct-push:
    name: Block Direct Push to Main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if push is from PR merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ github.event.head_commit.id }}
        run: |
          # Use GitHub API to check if commit came from a PR
          # This works for all merge types: merge, squash, and rebase
          OWNER_REPO="${{ github.repository }}"
          
          echo "üîç Checking if commit $COMMIT_SHA came from a PR..."
          
          # Call GitHub API to get PRs associated with this commit
          # The API returns an array of PRs, or empty array if commit is not from a PR
          PR_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$OWNER_REPO/commits/$COMMIT_SHA/pulls")
          
          # If curl failed or returned empty, treat as no PR found
          if [ -z "$PR_RESPONSE" ]; then
            PR_RESPONSE="[]"
          fi
          
          # Check if we got any PRs back (array length > 0)
          PR_COUNT=$(echo "$PR_RESPONSE" | jq 'length // 0' 2>/dev/null || echo "0")
          
          if [ "$PR_COUNT" -gt 0 ]; then
            PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.[0].number')
            PR_TITLE=$(echo "$PR_RESPONSE" | jq -r '.[0].title')
            echo "‚úÖ Commit $COMMIT_SHA came from PR #$PR_NUMBER: $PR_TITLE"
            echo "‚úÖ Allowing push - this is a PR merge"
            exit 0
          else
            # No PR found - this is a direct push
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "‚ùå ERROR: Direct pushes to main branch are not allowed!"
            echo ""
            echo "This commit ($COMMIT_SHA) does not appear to be from a Pull Request."
            echo "Branch protection rules should have prevented this push."
            echo ""
            echo "If you see this, please:"
            echo "  1. Create a feature branch: git checkout -b feature/your-feature-name"
            echo "  2. Push to that branch: git push origin feature/your-feature-name"
            echo "  3. Create a Pull Request: gh pr create"
            echo ""
            echo "For emergency hotfixes, use: git checkout -b hotfix/description"
            echo ""
            echo "Commit message: $COMMIT_MSG"
            exit 1
          fi
