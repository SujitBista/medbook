# Role-aware public doctor booking page — Summary of changes

## Goal

Render different UI for PATIENT, ADMIN, and GUEST so admins never see patient CTAs (e.g. "Pay & Book"), and enforce the same rule in the booking start API.

## 1. Role derivation

- **Page:** `role = session?.user?.role === "PATIENT" ? "PATIENT" : session?.user?.role === "ADMIN" ? "ADMIN" : "GUEST"` (only PATIENT and ADMIN are named; everyone else is GUEST).
- Used for a single "Choose a time window" section with role-based content; no separate "Available Time Slots" section for admins.

## 2. UI by role

### PATIENT

- Schedule windows with **Pay & Book** CTA.
- Price and "Choose a time window" (capacity-based) unchanged.
- Clicking Pay & Book calls `POST /api/bookings/start` and starts Stripe flow.

### ADMIN

- **No** "Pay & Book" button.
- **No** "Available Time Slots" section (removed for all roles; booking is capacity-only).
- **Admin view:** "Choose a time window" card with title **"Choose a time window — Read-only (Admin)"**, date picker, and read-only list: `09:00–12:00` and `Capacity / Booked / Remaining` per window.
- **AdminBookingBlockedCard** below the list: message "Admins cannot book from the public page.", actions "Go to Admin Dashboard" and "Browse Doctors".

### GUEST

- Same "Choose a time window" card with **read-only** schedule (no Pay & Book).
- **GuestCTA:** single "Sign in to book" button; redirects to login with `callbackUrl` back to this doctor page.

## 3. Shared UI

- Doctor card unchanged for all roles.
- "Choose a time window" title kept; subtitle/actions vary by role (read-only label for admin, Sign in for guest, Pay & Book for patient).
- Time-slot picker and "Available Time Slots" section removed (capacity-based only).

## 4. API enforcement

- **Backend** `POST /api/v1/bookings/start`: if `req.user.role !== UserRole.PATIENT` → `createAuthorizationError("Only patients can book appointments.")` → 403.
- **Web** `POST /api/bookings/start`: if `session.user.role !== "PATIENT"` → 403 JSON `{ success: false, error: { code: "FORBIDDEN", message: "Only patients can book appointments." } }`.
- Stripe and booking logic unchanged for patients.

## 5. New / updated files

- **`apps/web/app/doctors/[id]/components/AdminBookingBlockedCard.tsx`** — Admin message + links (Dashboard, Browse Doctors).
- **`apps/web/app/doctors/[id]/components/GuestCTA.tsx`** — "Sign in to book" with `callbackUrl`.
- **`apps/web/app/doctors/[id]/page.tsx`** — Role-derived, single "Choose a time window" card with PATIENT / ADMIN / GUEST branches; Pay & Book only for PATIENT; "Available Time Slots" and slot-based booking UI removed.
- **`apps/web/app/api/bookings/start/route.ts`** — 403 for non-PATIENT before proxying to backend.
- **`apps/api/src/controllers/booking.controller.ts`** — 403 for non-PATIENT before starting booking.

## 6. QA checklist

- [ ] Admin never sees "Pay & Book".
- [ ] Guest sees "Sign in to book" and read-only windows.
- [ ] Patient sees "Pay & Book" and can complete booking.
- [ ] `POST /api/bookings/start` as admin or guest returns 403 with message "Only patients can book appointments.".
- [ ] No console errors on the doctor page for any role.
